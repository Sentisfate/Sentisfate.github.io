<!DOCTYPE html>
<html><head>
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer" />
   
  <meta name="author" content="gisculibur">
  

   
  
  
  
  
  
  
  <meta name="keywords"
    content="theme,kagome">
  

  

  <meta name="generator" content="Hugo 0.115.2">


  
  
  
  
  <title>加载本地数据 🌟 GIS咖喱棒</title>

  <meta property="og:title" content="加载本地数据" />
<meta property="og:description" content="1.shapefile 思路：Cesium无法直接识别shapefile，因此需要将shapefile格式文件进行转换，考虑到Cesium直接支持的矢量数据格式有" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Sentisfate.github.io/docs/gml6fmm2rkb8ap2h/" /><meta property="article:section" content="docs" />
<meta property="article:published_time" content="2022-12-11T07:07:18+00:00" />
<meta property="article:modified_time" content="2023-04-25T12:28:03+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="加载本地数据"/>
<meta name="twitter:description" content="1.shapefile 思路：Cesium无法直接识别shapefile，因此需要将shapefile格式文件进行转换，考虑到Cesium直接支持的矢量数据格式有"/>


  
  
  
  
  <link rel="stylesheet" href="https://Sentisfate.github.io/assets/css/style.min.a9eba8a87a1f5444669cfe92317af83504187100f2529f484b2eeaff89777b86.css" integrity="sha256-qeuoqHofVERmnP6SMXr4NQQYcQDyUp9ISy7q/4l3e4Y=">

  <script src="https://Sentisfate.github.io/assets/js/main.min.182da266209851bc7c828aa7377f98f914e1e76c8decdd53a6cbe9bffea92cde.js" integrity="sha256-GC2iZiCYUbx8goqnN3&#43;Y&#43;RTh52yN7N1Tpsvpv/6pLN4="></script>

  </head><body><header class="header-container layout-block layout-padding">
  <div class="header-inner content-padding-large soft-size--large soft-style--box">
    <div class="header-logo">
      <a href="https://Sentisfate.github.io"><h1>GIS咖喱棒</h1></a>
    </div>
    <nav class="header-nav">
      <div class="header-nav--btn">
        <div class="btn-item"></div>
        <div class="btn-item"></div>
        <div class="btn-item"></div>
      </div>
      <div class="header-nav--list">
        <div>
          
          <a class="list-item soft-size--small soft-style--hover soft-style--active" href="/" title="GIS咖喱棒">主页</a>
          
          <a class="list-item soft-size--small soft-style--hover soft-style--active" href="/docs/" title="Docs">笔记</a>
          
          <a class="list-item soft-size--small soft-style--hover soft-style--active" href="/categories/" title="Categories">分类</a>
          
          <a class="list-item soft-size--small soft-style--hover soft-style--active" href="/tags/" title="Tags">标签</a>
          
        </div>
      </div>
    </nav>
  </div>
</header><main id="content">
    

    <div class="single-container layout-block">
      <div class="article-info">
        <div class="article-header layout-padding">
          <div class="article-cover card-container content-padding-large soft-size--large soft-style--box img">

  <div class="card-cover">
    
      <img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670831494939-30245c7b-76e1-4b8f-94f1-1bc95abbd956.png" alt="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670831494939-30245c7b-76e1-4b8f-94f1-1bc95abbd956.png" />
    
  </div>

  <div class="card-text">
    <h1 class="card-text--title">加载本地数据</h1>
    
      <p class="card-text--row">2022-12-11 07:07</p>
      
      
      

      
      
    
  </div>

</div>
        </div>

        <div class="article-content">
          <div class="markdown-body content-padding-large soft-size--large soft-style--box">
            <p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="1shapefile">1.shapefile</h1>
<p>思路：<!-- raw HTML omitted -->Cesium无法直接识别shapefile，因此需要将shapefile格式文件进行转换，考虑到Cesium直接支持的矢量数据格式有<code>geojson,topojson,kml,czml</code>，因此可以将shp转geojson</p>
<blockquote>
<p>geojson 概念详解 <a href="https://zh.m.wikipedia.org/zh-sg/GeoJSON" target="_blank" rel="noopener">https://zh.m.wikipedia.org/zh-sg/GeoJSON</a>
<a href="https://zhuanlan.zhihu.com/p/344042884" target="_blank" rel="noopener">Cesium开发基础篇 | 03加载矢量数据</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">viewer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Viewer</span>(<span style="color:#e6db74">&#39;cesiumContainer&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeoJsonDataSource</span>.<span style="color:#a6e22e">load</span>(<span style="color:#e6db74">&#39;../../SampleData/ne_10m_us_states.topojson&#39;</span>, {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">stroke</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">HOTPINK</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">PINK</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">strokeWidth</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">markerSymbol</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;?&#39;</span>
</span></span><span style="display:flex;"><span>}));
</span></span></code></pre></div><p>问题关键在于如何转换为geojson，这里调用某大佬写的shapefile转geojson脚本，参看：<!-- raw HTML omitted --><a href="https://github.com/calvinmetcalf/shapefile-js" target="_blank" rel="noopener">https://github.com/calvinmetcalf/shapefile-js</a><!-- raw HTML omitted -->使用过程。</p>
<ol>
<li>安装<code>npm i shpjs --save</code>，从下载下来的文件中，我们只选择shp.js文件，将其复制到我们的代码库即可</li>
</ol>
<p>
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670831494939-30245c7b-76e1-4b8f-94f1-1bc95abbd956.png#averageHue=%2324292d&amp;clientId=udcfe0234-9308-4&amp;from=paste&amp;height=405&amp;id=u2172dcda&amp;originHeight=506&amp;originWidth=384&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=23752&amp;status=done&amp;style=none&amp;taskId=ua4d26c1e-1d66-47a9-89c0-84a2a821845&amp;title=&amp;width=307.2" alt="image.png" loading="lazy" /></p>
</p>
<ol start="2">
<li>在需要使用的文件中以用该文件即可。如</li>
</ol>
<p>
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670831598783-036e9a79-1139-49d5-9399-e087e0029cb3.png#averageHue=%2327282a&amp;clientId=udcfe0234-9308-4&amp;from=paste&amp;height=342&amp;id=u0a5310b6&amp;originHeight=427&amp;originWidth=360&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=21375&amp;status=done&amp;style=none&amp;taskId=ucf523bb0-ad0c-4ee8-ab94-f85fa280a14&amp;title=&amp;width=288" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->在上面这种目录情况下，在app.jsx中引用即可<!-- raw HTML omitted --><code>import './common/js/shp.js';</code></p>
<ol start="3">
<li>接下来就可以愉快的调用<code>shp</code>方法来进行shapefile的转换了.</li>
</ol>
<blockquote>
<p>需要注意的一点是，就本人目前的踩坑经历，发现只需<code>.**shp**</code>，.<code>**dbf**</code>，<code>.prj</code>就可以转换为geojson</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// 以文件上传的形式为例，进行转换并在Cesium中显示
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">splitFileName</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">fullname</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fullname</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;.&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">arr</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> [<span style="color:#a6e22e">fullname</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">extname</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arr</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">prename</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arr</span>.<span style="color:#a6e22e">join</span>(<span style="color:#e6db74">&#39;.&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> [<span style="color:#a6e22e">prename</span>, <span style="color:#a6e22e">extname</span>];
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">upload</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">e</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">files</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">files</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 针对上传的是zip文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> [<span style="color:#a6e22e">prename</span>, <span style="color:#a6e22e">extname</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">splitFileName</span>(<span style="color:#a6e22e">files</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">extname</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;zip&#39;</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#39;请检查选择的文件是否正确，shpafile 的zip格式压缩包&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 读取zip文件的二进制数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">files</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">arrayBuffer</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 将二进制数据转为geojson
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">geojson</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">shp</span>(<span style="color:#a6e22e">buffer</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">geojson</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (Array.<span style="color:#a6e22e">isArray</span>(<span style="color:#a6e22e">geojson</span>)) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">item</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">geojson</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 多一个filename属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeoJsonDataSource</span>.<span style="color:#a6e22e">load</span>(<span style="color:#a6e22e">item</span>));
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeoJsonDataSource</span>.<span style="color:#a6e22e">load</span>(<span style="color:#a6e22e">geojson</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;zip 数据出错&#39;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">shpBuffer</span>, <span style="color:#a6e22e">dbfBuffer</span>, <span style="color:#a6e22e">prj</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">files</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> [<span style="color:#a6e22e">prename</span>, <span style="color:#a6e22e">extname</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">splitFileName</span>(<span style="color:#a6e22e">files</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">name</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">extname</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;shp&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">shpBuffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">files</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">arrayBuffer</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">extname</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;dbf&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">dbfBuffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">files</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">arrayBuffer</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">extname</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;prj&#39;</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">reader</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileReader</span>();
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">e</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">prj</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>          };
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">readAsText</span>(<span style="color:#a6e22e">files</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>        } 
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">shpBuffer</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">dbfBuffer</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">prj</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">geojson</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">shp</span>.<span style="color:#a6e22e">combine</span>([
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">shp</span>.<span style="color:#a6e22e">parseShp</span>(<span style="color:#a6e22e">shpBuffer</span>, <span style="color:#a6e22e">prj</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">shp</span>.<span style="color:#a6e22e">parseDbf</span>(<span style="color:#a6e22e">dbfBuffer</span>),
</span></span><span style="display:flex;"><span>          ]);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeoJsonDataSource</span>.<span style="color:#a6e22e">load</span>(<span style="color:#a6e22e">geojson</span>));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;加载shapefile数据出错&#39;</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">alert</span>(<span style="color:#e6db74">&#39;请检查数据是否正确&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  };
</span></span></code></pre></div><p>关于中文乱码问题<!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670853686826-b613da3e-fb3d-41d9-9d13-07688b252c48.png#averageHue=%23f1f0f0&amp;clientId=udcfe0234-9308-4&amp;from=paste&amp;id=u50192331&amp;originHeight=769&amp;originWidth=712&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=49315&amp;status=done&amp;style=none&amp;taskId=ud985057d-9447-4703-89b2-d60828e16a3&amp;title=" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->.dbf 文件头中第29个字节（从0开始）表示Language driver ID，其代表的编码页参照以下链接<!-- raw HTML omitted --><a href="http://shapelib.maptools.org/codepage.html?d=1563413688103" target="_blank" rel="noopener">http://shapelib.maptools.org/codepage.html?d=1563413688103</a><!-- raw HTML omitted -->在细看shpjs的源码时，发现了<code>shp.parseDbf()</code>有第二个可选参数编码格式cpg。正常在导出shapefile文件时，arcgis10.2.1以前版本，国内dbf格式编码为<code>GBK</code>，而以后版本默认为<code>UTF-8</code>。如果使用QGIS导出shapefile时，是可以选择编码格式的，并且多一个<code>.cpg</code>文件。因此对于中文乱码的解决方案就是通过设置cpg参数，和prj一样，字符串形式。如<code>'GBK'</code>，基本可以解决国内中文乱码问题。<!-- raw HTML omitted -->例：<code>shp.parseDbf(dbf,cpg)</code><!-- raw HTML omitted --><strong>当然，也可以通过上表的dbf文件的第29个字节，来进行动态判断当前dbf的编码格式。</strong></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="2在指定位置加载一张图片-img">2.在指定位置加载一张图片 img</h1>
<p>参考api</p>
<ul>
<li>ImageryLayer</li>
<li>ImageryProvider  影像图层的数据源</li>
</ul>
<p>在imagerProvider中有一个负责加载单个图片的api <code>**SingleTileImageryProvider**</code>。其接收的构造参数如下：<!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670920064426-ca22c6dc-33d3-4f5b-a856-747530180927.png#averageHue=%23f4f2f1&amp;clientId=u3dc7df94-d8d7-4&amp;from=paste&amp;height=359&amp;id=u5fe2f9d0&amp;originHeight=449&amp;originWidth=1301&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=74421&amp;status=done&amp;style=none&amp;taskId=u46cd8fd1-cfd1-4460-b10e-4b2325bc43a&amp;title=&amp;width=1040.8" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->也就是说需要加载图片，就必须要获得图片的url。如果图片在打包的文件夹中，可以直接通过网络路径或者相对路径来加载。而如何获得用户上传的图片的url，就是解决问题关键所在。<!-- raw HTML omitted --><code>**URL.createObjectUrl()**</code><strong>刚好可以帮助我们解决这个问题。</strong><!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670920321046-d0382c05-ea51-4d83-af29-ba82df0799d0.png#averageHue=%23252424&amp;clientId=u3dc7df94-d8d7-4&amp;from=paste&amp;height=294&amp;id=u5e695b31&amp;originHeight=367&amp;originWidth=1008&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=48898&amp;status=done&amp;style=none&amp;taskId=u03b32caf-106b-464b-ac4a-9a323452b65&amp;title=&amp;width=806.4" alt="image.png" loading="lazy" /></p>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">uploadImage</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">e</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">files</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">imgUrl</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">createObjectURL</span>(<span style="color:#a6e22e">file</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setUrl</span>(<span style="color:#a6e22e">imgUrl</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rectangle</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Rectangle</span>.<span style="color:#a6e22e">fromDegrees</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">112.2588781098</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">39.5047262435</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">112.2981585251</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">39.5233702752</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">imageryLayers</span>.<span style="color:#a6e22e">addImageryProvider</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">SingleTileImageryProvider</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">imgUrl</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rectangle</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rectangle</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">camera</span>.<span style="color:#a6e22e">setView</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">destination</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Rectangle</span>.<span style="color:#a6e22e">fromDegrees</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">112.2770508586</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">39.5050978677</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">112.2776657605</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">39.5193995362</span>
</span></span><span style="display:flex;"><span>    ), 
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">imageryLayer</span>.<span style="color:#a6e22e">getViewableRectangle</span>().<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">rectangle</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">camera</span>.<span style="color:#a6e22e">flyTo</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">destination</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">rectangle</span>
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>此时可以实现的是在指定位置上加载图片了，但是，由于Rectangle是水平垂直的，很明显不符合加载的目标。<!-- raw HTML omitted -->换一种思路，能否在实体上加载图片呢，实体是可以进行旋转平移等变换的。<!-- raw HTML omitted -->参考api</p>
<ul>
<li>Entity</li>
</ul>
<p>参考示例</p>
<ul>
<li><a href="https://sandcastle.cesium.com/?src=Rectangle.html&amp;label=Geometries" target="_blank" rel="noopener">https://sandcastle.cesium.com/?src=Rectangle.html&amp;label=Geometries</a></li>
<li><a href="https://sandcastle.cesium.com/?src=Plane.html&amp;label=Geometries" target="_blank" rel="noopener">https://sandcastle.cesium.com/?src=Plane.html&amp;label=Geometries</a></li>
<li><a href="https://sandcastle.cesium.com/index.html?src=Billboards.html" target="_blank" rel="noopener">https://sandcastle.cesium.com/index.html?src=Billboards.html</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">rotation</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.Math.<span style="color:#a6e22e">toRadians</span>(<span style="color:#ae81ff">30</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 动态旋转
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getRotationValue</span>() {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rotation</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.005</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rotation</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rec</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">add</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rectangle</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">coordinates</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Rectangle</span>.<span style="color:#a6e22e">fromDegrees</span>(<span style="color:#ae81ff">112</span>,<span style="color:#ae81ff">39</span>,<span style="color:#ae81ff">113</span>,<span style="color:#ae81ff">40</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//填充材料
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">material</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">imgUrl</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 矩形旋转
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">rotation</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">CallbackProperty</span>(<span style="color:#a6e22e">getRotationValue</span>, <span style="color:#66d9ef">false</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//矩形纹理旋转 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">stRotation</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">CallbackProperty</span>(<span style="color:#a6e22e">getRotationValue</span>, <span style="color:#66d9ef">false</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">classificationType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ClassificationType</span>.<span style="color:#a6e22e">TERRAIN</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 立方体底部高度，起始高度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">extrudedHeight</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0.0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 立方体的高度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">height</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100.0</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    });
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">plane</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">add</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Red plane with black outline&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 平面中心点的位置坐标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">fromDegrees</span>(<span style="color:#ae81ff">112.2981585251</span>, <span style="color:#ae81ff">39.5233702752</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">plane</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//平面的位置 ax+by+cz+d=0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">plane</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Plane</span>(<span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">UNIT_Z</span>, <span style="color:#ae81ff">0.0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 平面的宽高
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dimensions</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian2</span>(<span style="color:#ae81ff">4000.0</span>, <span style="color:#ae81ff">3000.0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">material</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">imgUrl</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">outline</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">outlineColor</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">BLACK</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">entity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">add</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// id: &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;billboard&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// show: true,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// description: &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// orientation: &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">fromDegrees</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">75.59777</span>, <span style="color:#ae81ff">40.03883</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">billboard</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">show</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, <span style="color:#75715e">// default
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">image</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;./images/Cesium_Logo_overlay.png&#34;</span>, <span style="color:#75715e">// default: undefined
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">scale</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2.0</span>, <span style="color:#75715e">// default: 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//像素偏移    type: Cartesian2    default:Cartesian2.ZERO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">pixelOffset</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian2</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">50</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//眼睛偏移    type: Cartesian3    default:Cartesian3.ZERO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">eyeOffset</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>),
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 水平对齐方式  type: HorizontalOrigin  default:HorizontalOrigin.CENTER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// CENTER 原点在对象的水平中心；LEFT 原点在对象的左侧；RIGHT 原点在对象的右侧
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">horizontalOrigin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">HorizontalOrigin</span>.<span style="color:#a6e22e">CENTER</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 垂直对齐方式  type: VerticalOrigin  default:VerticalOrigin.CENTER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// CENTER 原点位于 BASELINE 和 TOP 之间的垂直中心；BOTTOM 原点在对象的底部；
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// BASELINE 如果对象包含文本，则原点位于文本的基线，否则原点位于对象的底部；TOP 原点在对象的顶部
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">verticalOrigin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">VerticalOrigin</span>.<span style="color:#a6e22e">BOTTOM</span>, <span style="color:#75715e">// default: CENTER 垂直对齐位置 参考Cesium.VerticalOrigin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取或设置此广告牌的高度参考    type: HeightReference    default:HeightReference.NONE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// NONE 位置绝对；CLAMP_TO_GROUND 位置固定在地形上；RELATIVE_TO_GROUND 位置高度是指地形上方的高度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">heightReference</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">HeightReference</span>.<span style="color:#a6e22e">CLAMP_TO_GROUND</span>,
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 颜色  type: Color  default:Color.WHITE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">LIME</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取或设置以弧度为单位的旋转角度  type: number  default:0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rotation</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.Math.<span style="color:#a6e22e">PI_OVER_FOUR</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取或设置世界空间中的对齐轴  type:Cartesian3  default:Cartesian3.ZERO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">alignedAxis</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">ZERO</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">width</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span>, <span style="color:#75715e">// default: undefined
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">height</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">25</span>, <span style="color:#75715e">// default: undefined
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 根据广告牌与相机的距离获取或设置广告牌的近和远缩放属性  type:NearFarScalar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">scaleByDistance</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">NearFarScalar</span>(<span style="color:#ae81ff">1.0</span><span style="color:#a6e22e">e3</span>, <span style="color:#ae81ff">2.0</span>, <span style="color:#ae81ff">2.0</span><span style="color:#a6e22e">e3</span>, <span style="color:#ae81ff">1.0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 根据广告牌到相机的距离，获取或设置广告牌的近和远半透明属性  type:NearFarScalar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">translucencyByDistance</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">NearFarScalar</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1.0</span><span style="color:#a6e22e">e3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1.0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1.5</span><span style="color:#a6e22e">e6</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 根据广告牌与摄像头的距离，获取或设置广告牌的近像素偏移量和远像素偏移量缩放属性  type:NearFarScalar
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">pixelOffsetScaleByDistance</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">NearFarScalar</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1.0</span><span style="color:#a6e22e">e3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1.0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1.5</span><span style="color:#a6e22e">e6</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0.0</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 设置1000米和2000米之间可见  type:DistanceDisplayCondition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// distanceDisplayCondition: new Cesium.DistanceDisplayCondition(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//   1.0e3,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//   2.0e3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 获取或设置与相机的距离，在深度处禁用深度测试，例如，以防止剪切地形。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 设置为零时，将始终应用深度测试。设置为Number.POSITIVE_INFINITY时，永远不会应用深度测试。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">disableDepthTestDistance</span><span style="color:#f92672">:</span> Number.<span style="color:#a6e22e">POSITIVE_INFINITY</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span> 
</span></span></code></pre></div><p>改变图片的宽高，只需要调整其中的参数即可。改变图片的姿态，目前尝试只能调整平面的位置参数。模型的姿态可通过 orientation实现。</p>
<p>
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1671003637111-06593d80-e29e-48fb-82a8-faa4fbff0211.png#averageHue=%23e2d8ca&amp;clientId=u2b0e6119-a506-4&amp;from=paste&amp;id=ud8bcd2de&amp;originHeight=600&amp;originWidth=800&amp;originalType=url&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=231108&amp;status=done&amp;style=none&amp;taskId=ubdf0160f-1be3-4fab-a85b-caebf446615&amp;title=" alt="image.png" loading="lazy" /></p>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">orientation</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Transforms</span>.<span style="color:#a6e22e">headingPitchRollQuaternion</span>(<span style="color:#a6e22e">position</span>,<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">HeadingPitchRoll</span>.<span style="color:#a6e22e">fromDegrees</span>(<span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">0</span>))
</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="3加载栅格数据如-ascii">3.加载栅格数据如 ascii</h1>
<p><a href="https://blog.csdn.net/lovefengruoqing/article/details/115306876" target="_blank" rel="noopener">https://blog.csdn.net/lovefengruoqing/article/details/115306876</a><!-- raw HTML omitted -->对于ascii码，文件格式大概如下</p>
<pre tabindex="0"><code>NCOLS xxx
NROWS xxx
XLLCORNER xxx
YLLCORNER xxx
CELLSIZE xxx
NODATA_VALUE xxx
row 1
row 2
.
.
row n
</code></pre><pre tabindex="0"><code>NCOLS 480
NROWS 450
XLLCORNER 378922
YLLCORNER 4072345
CELLSIZE 30
NODATA_VALUE -32768
43 2 45 7 3 56 2 5 23 65 34 6 32 54 57 34
35 45 65 34 2 6 78 4 2 6 89 3 2 7 45 23 5 ...
</code></pre><ul>
<li><strong>NCOLS</strong> 和 <strong>NROWS</strong> 是由 ASCII 文件所定义的栅格的列数和行数。</li>
<li><strong>XLLCORNER</strong> 和 <strong>YLLCORNER</strong> 是左下角栅格像元的左下角坐标。也可使用 <strong>XLLCENTER</strong> 和 <strong>YLLCENTER</strong> 根据左下角栅格像元的中心坐标指定原点。</li>
<li><strong>CELLSIZE</strong> 是栅格像元的大小。</li>
<li><strong>NODATA_VALUE</strong> 是用于表示 NoData 像元的值。</li>
<li>像元值应由空格分隔。ASCII 文件中每行的末尾不必使用回车。文件头中的列数用于确定何时开始新的一行。</li>
</ul>
<p>解析思路：</p>
<ol>
<li>解析头文件，获取相应的参数</li>
<li>根据cellsize，左下角点的坐标计算右上角点坐标</li>
<li>依据投影进行转换，获取WGS84格式的左下右上角点坐标</li>
<li>读取像元值，存储到image，依据情况可能需要进行线性拉伸</li>
<li>在cesium中加载单个image</li>
</ol>
<p>针对某些大文件，进行逐行读取，参考资料：<!-- raw HTML omitted --><a href="https://blog.csdn.net/WuLex/article/details/51924267" target="_blank" rel="noopener">https://blog.csdn.net/WuLex/article/details/51924267</a></p>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="线性拉伸">线性拉伸</h2>
<p>公式<!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2023/png/29064333/1672568587320-6aec10e1-c735-4867-9878-7ab4af4e6567.png#averageHue=%23faf9f8&amp;clientId=u8ed7b3c5-e3e5-4&amp;from=paste&amp;height=70&amp;id=u3fb5b1f3&amp;originHeight=87&amp;originWidth=418&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=7281&amp;status=done&amp;style=none&amp;taskId=ub2efe3e6-cf79-4b23-8fd9-d14dde71fb2&amp;title=&amp;width=334.4" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->参数说明，<code>f(i,j)</code>第i行第j列的像素值(拉伸前)，<code>g(i,j)</code>拉伸后的像素值。A,B分别为拉伸前的最小和最大值，C，D为拉伸后的最小最大值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">stretch</span><span style="color:#f92672">=</span>(<span style="color:#a6e22e">value</span>,<span style="color:#a6e22e">sourceMax</span>,<span style="color:#a6e22e">sourceMin</span>,<span style="color:#a6e22e">targetMax</span>,<span style="color:#a6e22e">targetMin</span>)=&gt;{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (<span style="color:#a6e22e">targetMax</span><span style="color:#f92672">-</span><span style="color:#a6e22e">targetMin</span>)<span style="color:#f92672">/</span>(<span style="color:#a6e22e">sourceMax</span><span style="color:#f92672">-</span><span style="color:#a6e22e">sourceMin</span>)<span style="color:#f92672">*</span>(<span style="color:#a6e22e">value</span><span style="color:#f92672">-</span><span style="color:#a6e22e">sourceMin</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">targetMin</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="读写像素">读写像素</h2>
<p>利用canvas来进行像素的绘制，从而生成image，涉及到的api有，</p>
<ul>
<li>canvas.getContext</li>
<li>ctx.createImageData  创建像素的信息</li>
<li>imageData.data</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createQueue</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dequeue</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>[<span style="color:#a6e22e">offset</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">list</span>[<span style="color:#a6e22e">offset</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">offset</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">offset</span> <span style="color:#f92672">&gt;</span> (<span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">offset</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 删除前面的空数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">offset</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">offset</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">enqueue</span> <span style="color:#f92672">=</span> (...<span style="color:#a6e22e">arr</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">push</span>(...<span style="color:#a6e22e">arr</span>);
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pop</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dequeue</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">enqueue</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pop</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 用代理来实现索引器的效果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Proxy(<span style="color:#a6e22e">list</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">prop</span>, <span style="color:#a6e22e">receiver</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">prop</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">prop</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;length&#39;</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">offset</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (isNaN(<span style="color:#a6e22e">index</span>)) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">prop</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">index</span>];
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">prop</span>, <span style="color:#a6e22e">value</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">prop</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (isNaN(<span style="color:#a6e22e">index</span>)) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">index</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offset</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 自定义事件有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  line 获取每次读取的一行的数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  end 读取结束的事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  progress 读取进度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  error 发生错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LineReader</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {object} options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *   @param {number} chunkSize 每次读取的大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *   @param {string} encoding 文件的编码格式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">options</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 进度条
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">loading</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">internals</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">self</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileReader</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果有就按自定义的大小读取文件，没有，就一次读取1024byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkSize</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">chunkSize</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">chunkSize</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建一个对象 让用户自定义事件回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">events</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在filereader终止时会将canRead设置为false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">canRead</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">encoding</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">encoding</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;UTF-8&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 进程回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">onprogress</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">e</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkLoaded</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">loaded</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">proportion</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        ((<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">totalLoaded</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkLoaded</span>) <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">fileLength</span>) <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;progress&#39;</span>, [<span style="color:#a6e22e">proportion</span>, <span style="color:#a6e22e">internals</span>]);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 读取完成的回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// progress进程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">totalLoaded</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkLoaded</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// chunk 存储读取的字符串，上一次读取的块可能会保留最后一行，对于单字节字符都是字符串就可以直接相加，因为1字节(byte)等于8位(bit)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 判断是否存在换行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">/\r|\n/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 拆分行数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">enqueue</span>(...<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>.<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/[^\r\n]+/g</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果仍有更多数据读取，保留最后一行，可能不完整
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_hasMoreData</span>()) {
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// 如果块以\n换行结尾，最后一行完整，不再需要单独保留
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>[<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;\n&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">:</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 按步骤进行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_step</span>();
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//文本不包含换行符
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 有数据剩下继续读取下一个块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_hasMoreData</span>()) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">read</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 没有数据剩下了，但仍然有存储在块的数据发出它作为一行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;line&#39;</span>, [
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>.<span style="color:#a6e22e">bind</span>(<span style="color:#a6e22e">self</span>, <span style="color:#e6db74">&#39;end&#39;</span>),
</span></span><span style="display:flex;"><span>          ]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 块内没有存储的数据，就结束
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;end&#39;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">onError</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;error&#39;</span>, [<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">error</span>]);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">on</span>(<span style="color:#a6e22e">eventName</span>, <span style="color:#a6e22e">cb</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>.<span style="color:#a6e22e">events</span>[<span style="color:#a6e22e">eventName</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">cb</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * 是否还有数据未读取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns boolean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_hasMoreData</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">internals</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">fileLength</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * 触发自定义事件的回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {string} event 事件名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {arguments} args 回调函数的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_emit</span>(<span style="color:#a6e22e">event</span>, <span style="color:#a6e22e">args</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">boundEvents</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>.<span style="color:#a6e22e">events</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">boundEvents</span>[<span style="color:#a6e22e">event</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;function&#39;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">boundEvents</span>[<span style="color:#a6e22e">event</span>].<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">args</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *  按照chuncksize读取文件，并获得相应的internals初始参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {File} file 要读取的文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">file</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">internals</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果文件是有效的，获得其相关信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;undefined&#39;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">file</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">fileLength</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">size</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkLoaded</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">totalLoaded</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">createQueue</span>(); <span style="color:#75715e">//使用队列替代数组，优化性能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将文件的一部分提取出来，这里是逐行读取的精华所在
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blob</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">slice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkSize</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将开始读取的位置移动到本次读取的chunk后
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkSize</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对于单字节编码的字符的读取是没问题的，对于多字节编码的字符，如汉字，可能会存在2个字节的字符被截取了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">readAsText</span>(<span style="color:#a6e22e">blob</span>, <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">encoding</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 终止读取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">abort</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>.<span style="color:#a6e22e">canRead</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * 将internals.lines里的数据逐行发送出去，触发 on监听的 &#39;line&#39; 事件，没有行剩下时，判断是否还有数据，有就继续读取，触发 read() 没有触发end事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_step</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">internals</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果没有行剩下发送，但仍有数据剩下被读取，再次启动读取进程，否则发送结束事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_hasMoreData</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;end&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 当前读取到的行数并不为0，并且没有被废弃，将lines逐行发送
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">canRead</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;line&#39;</span>, [<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">dequeue</span>(), <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_step</span>.<span style="color:#a6e22e">bind</span>(<span style="color:#66d9ef">this</span>)]);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;end&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">canvas</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;canvas&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ctx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">canvas</span>.<span style="color:#a6e22e">getContext</span>(<span style="color:#e6db74">&#39;2d&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">uploadRaster</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">files</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LineReader</span>({ <span style="color:#a6e22e">chunkSize</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span> });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">max</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">9999</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">min</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">99999</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">pixels</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">imageData</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">headParas</span> <span style="color:#f92672">=</span> []; <span style="color:#75715e">// cols, rows, xllCorner, yllCorner, cellsize, nodataValue
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">rec</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readHead</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;end&#39;</span>, <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 计算图片范围
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">rec</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">3</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">rx</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">*</span> <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#a6e22e">rec</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">ry</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">*</span> <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#a6e22e">rec</span>[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rec</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">rx</span>, <span style="color:#a6e22e">ry</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">pixels</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pixels</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">==</span> <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">5</span>]) <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">value</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">stretch</span>(<span style="color:#a6e22e">pixels</span>[<span style="color:#a6e22e">i</span>], <span style="color:#a6e22e">max</span>, <span style="color:#a6e22e">min</span>, <span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">imageData</span>.<span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">255</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">putImageData</span>(<span style="color:#a6e22e">imageData</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">canvas</span>.<span style="color:#a6e22e">toDataURL</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">url</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// var newWindow = window.open(&#39;&#39;);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// newWindow.document.body.innerHTML = &#39;&lt;img src=&#34;&#39; + url + &#39;&#34; alt=&#34;&#34;&gt;&#39;;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">add</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">rectangle</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">coordinates</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Rectangle</span>.<span style="color:#a6e22e">fromDegrees</span>(...<span style="color:#a6e22e">rec</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//填充材料
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">material</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">url</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">classificationType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ClassificationType</span>.<span style="color:#a6e22e">TERRAIN</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;error&#39;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;progress&#39;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">proportion</span>, <span style="color:#a6e22e">internals</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">proportion</span>);
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">files</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">readHead</span>(<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">next</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39; &#39;</span>).<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">count</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">6</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">headParas</span>.<span style="color:#a6e22e">push</span>(Number(<span style="color:#a6e22e">arr</span>[<span style="color:#ae81ff">1</span>]));
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">count</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">count</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readBody</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">imageData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">createImageData</span>(<span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">canvas</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">canvas</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setTimeout</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">readBody</span>(<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">next</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// return
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// console.log(&#39;jj&#39;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39; &#39;</span>).<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将像素值写入imagedata 是一个一维数组， 连续4个元素表示rgba， 就灰度图来说rgb应该等比例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">arr</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">item</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pixels</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">item</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">headParas</span>[<span style="color:#ae81ff">5</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">max</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">max</span>(<span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">max</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">min</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">min</span>(<span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">min</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setTimeout</span>(() =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="4加载等值面三角网">4.加载等值面三角网</h1>
<p>元数据类型为csv文件，数据格式如下<!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1672122095469-f44f0862-82b7-4377-ac23-fa7412dbd163.png#averageHue=%23f7f4f4&amp;clientId=u85896181-579a-4&amp;from=paste&amp;height=583&amp;id=uc7f7cc79&amp;originHeight=729&amp;originWidth=920&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=279493&amp;status=done&amp;style=none&amp;taskId=u0b51b0e8-02fe-4ef8-869e-82e33f3209d&amp;title=&amp;width=736" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->能看到这里的等值面由许多坐标对组成的三角形构成。因此，问题的关键在于解决下面两个问题。</p>
<ol>
<li>在cesium中画三角形</li>
<li>从文件中读取除坐标对</li>
</ol>
<p>先来解决第一个问题，由于要绘制的三角形数量很多，采用primitive的方式来绘制。</p>
<blockquote>
<p>这一路是疯狂踩坑踩过来的。/(ㄒoㄒ)/~~</p>
</blockquote>
<p>简单谈一下这个primitive api，是一个接近底层的绘图api。没接触过webgl，opengl，对其不了解。<!-- raw HTML omitted -->primitive由两部分组成</p>
<ul>
<li><code>**GeometryInstance **</code> 几何实例
<ul>
<li>geometry  几何形状</li>
<li>attributes  实例的属性</li>
</ul>
</li>
<li><code>**Appearance**</code> 外观</li>
</ul>
<blockquote>
<p>注意，geometryInstance和appearance要对应，否则会报错</p>
</blockquote>
<p>使用primitive的好处有</p>
<ol>
<li>性能好，GPU代替CPU，相对于实体entities，大量图形(实体)会增加CPU的负担，使用primitive可以将多个图形合为一个geometry。</li>
<li>灵活，几何和外观是分离的</li>
</ol>
<p>缺点：</p>
<ol>
<li>难度大，要有图形学编程的基础</li>
<li>代码量多</li>
</ol>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="画一个三角形">画一个三角形</h2>
<p>要画一个三角形，需要确定其几何形状和外观。用一系列点坐标来表示形状。这里有两个注意点，</p>
<ol>
<li>位置为1维数组，依次为x，y，z，</li>
<li>坐标系统为笛卡尔空间直角坐标，不是经纬度，经纬度通过<code>**Cesium.Cartesian3.fromDegrees**</code><strong>转换</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positions</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>([
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">0.0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">8000000.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">8000000.0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">8500000.0</span>, <span style="color:#ae81ff">8000000.0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">8000000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">8500000.0</span>,
</span></span><span style="display:flex;"><span>]);
</span></span></code></pre></div><p>生成geometry</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">geometry</span> <span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Geometry</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryAttribute</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">componentDatatype</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ComponentDatatype</span>.<span style="color:#a6e22e">DOUBLE</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">componentsPerAttribute</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">values</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">positions</span>,
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">primitiveType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PrimitiveType</span>.<span style="color:#a6e22e">TRIANGLES</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">boundingSphere</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">BoundingSphere</span>.<span style="color:#a6e22e">fromVertices</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">positions</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// new Cesium.Cartesian3(0.0, 0.0, 0.0),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">indices</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">indices</span>,
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryInstance</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geometry</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">geometry</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;sanjiaoxing&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ColorGeometryInstanceAttribute</span>.<span style="color:#a6e22e">fromColor</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">AQUA</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>创建外观，注意这里flat必须为true，否则会报错</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appearance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PerInstanceColorAppearance</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">flat</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// translucent: true,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span></code></pre></div><p>创建primitive并添加到scene中。注意，如果需要异步创建图形，需要指定web worker，否则请设置为<code>asynchronous:false</code>，不然报错</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">primitive</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Primitive</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geometryInstances</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instance</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">appearance</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">appearance</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">asynchronous</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">primitive</span>);
</span></span></code></pre></div><p>这样就可以画出三角形了<!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1672220346157-9c81b5cc-04cc-4104-a0b4-3e75d18156c5.png#averageHue=%238f9d95&amp;clientId=u2bdc1bfc-a0c0-4&amp;from=paste&amp;height=532&amp;id=ub08e1592&amp;originHeight=665&amp;originWidth=914&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=543904&amp;status=done&amp;style=none&amp;taskId=u1c1afe8d-6a7f-4fc6-a435-f08ecc8cd8c&amp;title=&amp;width=731.2" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->想要线框图，可以修改成这样</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// 看这里看这里
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">geometry</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryPipeline</span>.<span style="color:#a6e22e">toWireframe</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Geometry</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryAttribute</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">componentDatatype</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ComponentDatatype</span>.<span style="color:#a6e22e">DOUBLE</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">componentsPerAttribute</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">values</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">positions</span>,
</span></span><span style="display:flex;"><span>      }),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">primitiveType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PrimitiveType</span>.<span style="color:#a6e22e">TRIANGLES</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">boundingSphere</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">BoundingSphere</span>.<span style="color:#a6e22e">fromVertices</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">positions</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// new Cesium.Cartesian3(0.0, 0.0, 0.0),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">indices</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">indices</span>,
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1672220590113-e58955e8-e5ea-4850-8f2d-1d9ce8299fda.png#averageHue=%23020202&amp;clientId=u2bdc1bfc-a0c0-4&amp;from=paste&amp;height=495&amp;id=u7387cc92&amp;originHeight=619&amp;originWidth=555&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=171726&amp;status=done&amp;style=none&amp;taskId=u7827e9ba-4a39-499d-985b-0cbc5a13ce2&amp;title=&amp;width=444" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->如果想要不同的面之间有阴影效果，如下<!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1672231159695-5e0cbee4-82e4-4283-9256-b81af4f6e7aa.png#averageHue=%23899a8f&amp;clientId=u2bdc1bfc-a0c0-4&amp;from=paste&amp;height=421&amp;id=u4db2d3ad&amp;originHeight=526&amp;originWidth=972&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=267518&amp;status=done&amp;style=none&amp;taskId=u4440c73f-8bb0-451e-a3ab-2d4d73f1038&amp;title=&amp;width=777.6" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->需要添加法向量，并设置开启<code>**flat:false**</code><!-- raw HTML omitted -->法向量使用<code>Cesium.GeometryPipeline.computeNormal</code>进行计算，当然你也可以自己算😀，使用computeNormal时，需要加上顶点索引，请确保每个顶点都是独一无二的。代码如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positions</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>([
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">0.0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">7500000.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">7500000.0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0.0</span>,
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">positions</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">indices</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#a6e22e">count</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">count</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">indices</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">i</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//阴影效果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">geometry</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryPipeline</span>.<span style="color:#a6e22e">computeNormal</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Cesium.GeometryPipeline.toWireframe(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Geometry</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryAttribute</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">componentDatatype</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ComponentDatatype</span>.<span style="color:#a6e22e">DOUBLE</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">componentsPerAttribute</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">values</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">positions</span>,
</span></span><span style="display:flex;"><span>      }),
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">primitiveType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PrimitiveType</span>.<span style="color:#a6e22e">TRIANGLES</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">boundingSphere</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">BoundingSphere</span>.<span style="color:#a6e22e">fromVertices</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">positions</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// new Cesium.Cartesian3(0.0, 0.0, 0.0),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">indices</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">indices</span>,
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// );
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryInstance</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geometry</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">geometry</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;sanjiaoxing&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ColorGeometryInstanceAttribute</span>.<span style="color:#a6e22e">fromColor</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">AQUA</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appearance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PerInstanceColorAppearance</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// flat: true,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// translucent: true,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">primitive</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Primitive</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geometryInstances</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instance</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">appearance</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">appearance</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">asynchronous</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">primitive</span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryInstance</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geometry</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">geometry</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;sanjiaoxing&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ColorGeometryInstanceAttribute</span>(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">0.5</span>),
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="加载不同顶点颜色的三角形">加载不同顶点颜色的三角形</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">//定义三角形的三个顶点的坐标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">vertex1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">fromDegrees</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">115.0</span>, <span style="color:#ae81ff">37.0</span>, <span style="color:#ae81ff">100000.0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">vertex2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">fromDegrees</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">107.0</span>, <span style="color:#ae81ff">33.0</span>, <span style="color:#ae81ff">100000.0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">vertex3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">fromDegrees</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">102.0</span>, <span style="color:#ae81ff">40.0</span>, <span style="color:#ae81ff">100000.0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//定义三个顶点的颜色
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">red</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">RED</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">green</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">GREEN</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">blue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Color</span>.<span style="color:#a6e22e">BLUE</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//组装数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">positions</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>([
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex1</span>.<span style="color:#a6e22e">x</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex1</span>.<span style="color:#a6e22e">y</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex1</span>.<span style="color:#a6e22e">z</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex2</span>.<span style="color:#a6e22e">x</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex2</span>.<span style="color:#a6e22e">y</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex2</span>.<span style="color:#a6e22e">z</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex3</span>.<span style="color:#a6e22e">x</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex3</span>.<span style="color:#a6e22e">y</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertex3</span>.<span style="color:#a6e22e">z</span>,
</span></span><span style="display:flex;"><span>    ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">0.5</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//定义顶点着色器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">vs</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;attribute vec3 position3DHigh;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    attribute vec3 position3DLow;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    attribute vec4 color;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    varying vec4 v_color;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    attribute float batchId;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    void main()\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        vec4 p = czm_computePosition();\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        v_color = color;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        p = czm_modelViewProjectionRelativeToEye * p;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gl_Position = p;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        gl_PointSize = 10.0;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//定义片元着色器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fs</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;varying vec4 v_color;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    void main()\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    {\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         float d = distance(gl_PointCoord, vec2(0.5,0.5));\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         if(d &lt; 0.5){\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            gl_FragColor = v_color;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         }else{\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            discard;\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         }\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    }\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">geometry</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Geometry</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryAttribute</span>({
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">componentDatatype</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ComponentDatatype</span>.<span style="color:#a6e22e">DOUBLE</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">componentsPerAttribute</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">values</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">positions</span>,
</span></span><span style="display:flex;"><span>        }),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryAttribute</span>({
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">componentDatatype</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ComponentDatatype</span>.<span style="color:#a6e22e">FLOAT</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">componentsPerAttribute</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">values</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">colors</span>,
</span></span><span style="display:flex;"><span>        }),
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// vertexFormat: Cesium.VertexFormat.POSITION_AND_COLOR,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">indices</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint32Array</span>([<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>]),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">primitiveType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PrimitiveType</span>.<span style="color:#a6e22e">TRIANGLES</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">boundingSphere</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">BoundingSphere</span>.<span style="color:#a6e22e">fromVertices</span>(<span style="color:#a6e22e">positions</span>),
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appearance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">MaterialAppearance</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">vertexShaderSource</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">vs</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">fragmentShaderSource</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">fs</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">renderState</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// blending: Cesium.BlendingState.PRE_MULTIPLIED_ALPHA_BLEND,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">depthTest</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">enabled</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }, <span style="color:#75715e">//报错 depthMask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">primitive</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Primitive</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">geometryInstances</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryInstance</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">geometry</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">geometry</span>,
</span></span><span style="display:flex;"><span>      }),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">appearance</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">appearance</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">asynchronous</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">primitive</span>);
</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="动态修改三角形的颜色">动态修改三角形的颜色</h2>
<p>待续
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="踩坑之路">踩坑之路</h2>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="问题1">问题1.</h3>
<p>
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1672152746205-128bea95-f1ae-497c-aa72-4c5ff051d885.png#averageHue=%23deb8b2&amp;clientId=u124a9a73-c27f-4&amp;from=paste&amp;height=185&amp;id=u122a1dee&amp;originHeight=231&amp;originWidth=623&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=20258&amp;status=done&amp;style=none&amp;taskId=u083f65d5-8529-4a88-8d2d-b309f464782&amp;title=&amp;width=498.4" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->产生原因，没有从（0，0，0）到2D的投影，如果不关心2D，可以这样设置：var viewer = new Cesium.Viewer(&lsquo;cesiumContainer&rsquo;, { scene3DOnly: true });
<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h3 id="问题2顶点索引相关问题">问题2.顶点索引相关问题</h3>
<ol>
<li>一维数组</li>
<li>表示连接各点的顺序</li>
<li>长度一般为总共 positions数组长度的三分之一，即总共顶点的个数。</li>
</ol>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="读取csv">读取csv</h2>
<p>行读取工具类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">createQueue</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">list</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dequeue</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>[<span style="color:#a6e22e">offset</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">list</span>[<span style="color:#a6e22e">offset</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">offset</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">offset</span> <span style="color:#f92672">&gt;</span> (<span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">offset</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 删除前面的空数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">splice</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">offset</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">offset</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">enqueue</span> <span style="color:#f92672">=</span> (...<span style="color:#a6e22e">arr</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">push</span>(...<span style="color:#a6e22e">arr</span>);
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pop</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dequeue</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">enqueue</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pop</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 用代理来实现索引器的效果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Proxy(<span style="color:#a6e22e">list</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">prop</span>, <span style="color:#a6e22e">receiver</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">prop</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">prop</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;length&#39;</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">offset</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (isNaN(<span style="color:#a6e22e">index</span>)) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">obj</span>[<span style="color:#a6e22e">prop</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">index</span>];
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">target</span>, <span style="color:#a6e22e">prop</span>, <span style="color:#a6e22e">value</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">prop</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (isNaN(<span style="color:#a6e22e">index</span>)) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">target</span>[<span style="color:#a6e22e">index</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offset</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">value</span>;
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 自定义事件有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  line 获取每次读取的一行的数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  end 读取结束的事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  progress 读取进度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *  error 发生错误
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LineReader</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {object} options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *   @param {number} chunkSize 每次读取的大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *   @param {string} encoding 文件的编码格式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">options</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 进度条
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">loading</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">internals</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">self</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">FileReader</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果有就按自定义的大小读取文件，没有，就一次读取1024byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkSize</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">options</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">chunkSize</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">chunkSize</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1024</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建一个对象 让用户自定义事件回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">events</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 在filereader终止时会将canRead设置为false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">canRead</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">encoding</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">options</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">encoding</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;UTF-8&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 进程回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">onprogress</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">e</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkLoaded</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">loaded</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">proportion</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        ((<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">totalLoaded</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkLoaded</span>) <span style="color:#f92672">/</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">fileLength</span>) <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">100</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;progress&#39;</span>, [<span style="color:#a6e22e">proportion</span>, <span style="color:#a6e22e">internals</span>]);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 读取完成的回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// progress进程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">totalLoaded</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkLoaded</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// chunk 存储读取的字符串，上一次读取的块可能会保留最后一行，对于单字节字符都是字符串就可以直接相加，因为1字节(byte)等于8位(bit)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span> <span style="color:#f92672">+=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 判断是否存在换行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">/\r|\n/</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 拆分行数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">enqueue</span>(...<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>.<span style="color:#a6e22e">match</span>(<span style="color:#e6db74">/[^\r\n]+/g</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果仍有更多数据读取，保留最后一行，可能不完整
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_hasMoreData</span>()) {
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// 如果块以\n换行结尾，最后一行完整，不再需要单独保留
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>[<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;\n&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">:</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">pop</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 按步骤进行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_step</span>();
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//文本不包含换行符
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 有数据剩下继续读取下一个块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_hasMoreData</span>()) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">read</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 没有数据剩下了，但仍然有存储在块的数据发出它作为一行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>.<span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;line&#39;</span>, [
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>.<span style="color:#a6e22e">bind</span>(<span style="color:#a6e22e">self</span>, <span style="color:#e6db74">&#39;end&#39;</span>),
</span></span><span style="display:flex;"><span>          ]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 块内没有存储的数据，就结束
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;end&#39;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">onError</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">self</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;error&#39;</span>, [<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">error</span>]);
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">on</span>(<span style="color:#a6e22e">eventName</span>, <span style="color:#a6e22e">cb</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>.<span style="color:#a6e22e">events</span>[<span style="color:#a6e22e">eventName</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">cb</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * 是否还有数据未读取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns boolean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_hasMoreData</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">internals</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">fileLength</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * 触发自定义事件的回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {string} event 事件名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {arguments} args 回调函数的参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_emit</span>(<span style="color:#a6e22e">event</span>, <span style="color:#a6e22e">args</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">boundEvents</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>.<span style="color:#a6e22e">events</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">boundEvents</span>[<span style="color:#a6e22e">event</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;function&#39;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">boundEvents</span>[<span style="color:#a6e22e">event</span>].<span style="color:#a6e22e">apply</span>(<span style="color:#66d9ef">this</span>, <span style="color:#a6e22e">args</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   *  按照chuncksize读取文件，并获得相应的internals初始参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @param {File} file 要读取的文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">file</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">internals</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果文件是有效的，获得其相关信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">file</span> <span style="color:#f92672">!==</span> <span style="color:#e6db74">&#39;undefined&#39;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">file</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">file</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">fileLength</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">size</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunk</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkLoaded</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">totalLoaded</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">createQueue</span>(); <span style="color:#75715e">//使用队列替代数组，优化性能
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将文件的一部分提取出来，这里是逐行读取的精华所在
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">blob</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">slice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkSize</span>
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将开始读取的位置移动到本次读取的chunk后
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">readPos</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">chunkSize</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 对于单字节编码的字符的读取是没问题的，对于多字节编码的字符，如汉字，可能会存在2个字节的字符被截取了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">reader</span>.<span style="color:#a6e22e">readAsText</span>(<span style="color:#a6e22e">blob</span>, <span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">encoding</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 终止读取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">abort</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>.<span style="color:#a6e22e">canRead</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * 将internals.lines里的数据逐行发送出去，触发 on监听的 &#39;line&#39; 事件，没有行剩下时，判断是否还有数据，有就继续读取，触发 read() 没有触发end事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   * @returns
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">_step</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">internals</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_internals</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果没有行剩下发送，但仍有数据剩下被读取，再次启动读取进程，否则发送结束事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_hasMoreData</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>();
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;end&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 当前读取到的行数并不为0，并且没有被废弃，将lines逐行发送
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">canRead</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;line&#39;</span>, [<span style="color:#a6e22e">internals</span>.<span style="color:#a6e22e">lines</span>.<span style="color:#a6e22e">dequeue</span>(), <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_step</span>.<span style="color:#a6e22e">bind</span>(<span style="color:#66d9ef">this</span>)]);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">_emit</span>(<span style="color:#e6db74">&#39;end&#39;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>声明存储读取结果的变量</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> [<span style="color:#a6e22e">collection</span>, <span style="color:#a6e22e">setCollection</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>([]);
</span></span></code></pre></div><p>获取</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LineReader</span>({});
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">isosurfaceCollection</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">row</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">readHead</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">row</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">row</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 如 有多少个值 值分别为 5,25,30,40,50,60,,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;,&#39;</span>).<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">arr</span>[<span style="color:#ae81ff">0</span>]; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">isosurfaceCollection</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;isosurface-&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">i</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">tins</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">val</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getColorRgba</span>(<span style="color:#a6e22e">val</span>), <span style="color:#75715e">//获取value对应的颜色值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    });
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readChunkHead</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">line</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">isosurfaceCollection</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// row 为2 0行开始，第2行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">targetRow</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">readChunkHead</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;,&#39;</span>).<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// len = arr[2]; //这一个值域的数组的长度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">targetRow</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">arr</span>[<span style="color:#ae81ff">2</span>]) <span style="color:#f92672">+</span> <span style="color:#a6e22e">row</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 指针加1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">index</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readChunk</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">readChunk</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// index 等值面数组中的第几个
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">//  targetRow 要读到第几行才算读完这一块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// row 当前的行数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">row</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">row</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">targetRow</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readChunkHead</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">row</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">line</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;,&#39;</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">item</span>) =&gt; Number(<span style="color:#a6e22e">item</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// let [x, y, z] = arr;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">z</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">fromDegrees</span>(...<span style="color:#a6e22e">arr</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">isosurfaceCollection</span>[<span style="color:#a6e22e">index</span>].<span style="color:#a6e22e">tins</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">z</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;error&#39;</span>, (<span style="color:#a6e22e">err</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;progress&#39;</span>, (<span style="color:#a6e22e">proportion</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(Math.<span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">proportion</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;%&#39;</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;end&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;读取结束&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">isosurfaceCollection</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setCollection</span>(<span style="color:#a6e22e">isosurfaceCollection</span>);
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readHead</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">files</span>[<span style="color:#ae81ff">0</span>]);
</span></span></code></pre></div><p>获取对应的颜色</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">colortoRgb</span>(<span style="color:#a6e22e">color</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 16进制颜色值的正则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">reg</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 把颜色值变成小写
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">color</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">color</span>.<span style="color:#a6e22e">toLowerCase</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">reg</span>.<span style="color:#a6e22e">test</span>(<span style="color:#a6e22e">color</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 如果只有三位的值，需变成六位，如：#fff =&gt; #ffffff
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">color</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">colorNew</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;#&#39;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">colorNew</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">color</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">concat</span>(<span style="color:#a6e22e">color</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>));
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">color</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">colorNew</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 处理六位的颜色值，转为RGB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">colorChange</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">7</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">colorChange</span>.<span style="color:#a6e22e">push</span>(parseInt(<span style="color:#e6db74">&#39;0x&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">color</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>))<span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">colorChange</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">color</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">COLORVALUELIST</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#ad90f0&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">70</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#9600b4&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">65</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#ff00f0&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">60</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#c00000&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">55</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#d60000&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">50</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#ff0000&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">45</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#ff9000&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">40</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#e7c000&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">35</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#ffff00&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">30</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#019000&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">25</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#00d800&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">20</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#00ecec&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">15</span> },
</span></span><span style="display:flex;"><span>  { <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;#01a0f6&#39;</span>, <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span> },
</span></span><span style="display:flex;"><span>];
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @param {number} value 值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getColorRgba</span>(<span style="color:#a6e22e">value</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">COLORVALUELIST</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">value</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">COLORVALUELIST</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">colortoRgb</span>(<span style="color:#a6e22e">COLORVALUELIST</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">color</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">value</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">COLORVALUELIST</span>[<span style="color:#a6e22e">len</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">colortoRgb</span>(<span style="color:#a6e22e">COLORVALUELIST</span>[<span style="color:#a6e22e">len</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">color</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">len</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">COLORVALUELIST</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">value</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">COLORVALUELIST</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">value</span>
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">colortoRgb</span>(<span style="color:#a6e22e">COLORVALUELIST</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">color</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>加载等值面</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getGeometryInstance</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">positions</span>, <span style="color:#a6e22e">color</span>) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// const positions = new Float64Array(collection[0].tins);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">positions</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">indices</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#a6e22e">count</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">count</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">indices</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">i</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">geometry</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryPipeline</span>.<span style="color:#a6e22e">computeNormal</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Cesium.GeometryPipeline.toWireframe(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Geometry</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryAttribute</span>({
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">componentDatatype</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ComponentDatatype</span>.<span style="color:#a6e22e">DOUBLE</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">componentsPerAttribute</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">values</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">positions</span>,
</span></span><span style="display:flex;"><span>        }),
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">primitiveType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PrimitiveType</span>.<span style="color:#a6e22e">TRIANGLES</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">boundingSphere</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">BoundingSphere</span>.<span style="color:#a6e22e">fromVertices</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">positions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// new Cesium.Cartesian3(0.0, 0.0, 0.0),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      ),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">indices</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">indices</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryInstance</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">geometry</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">geometry</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">color</span> <span style="color:#75715e">/* new Cesium.ColorGeometryInstanceAttribute(1.0, 1.0, 1.0, 0.5), */</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instances</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">collection</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">instances</span>.<span style="color:#a6e22e">push</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getGeometryInstance</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">collection</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#a6e22e">collection</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">tins</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ColorGeometryInstanceAttribute</span>(...<span style="color:#a6e22e">collection</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">color</span>, <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">instances</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appearance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PerInstanceColorAppearance</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// flat: true,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// translucent: true,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">primitive</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Primitive</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geometryInstances</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instances</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">appearance</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">appearance</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">asynchronous</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">primitive</span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">as</span> <span style="color:#a6e22e">Cesium</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;cesium&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useState</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">LineReader</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;../common/utils/LineReader&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">getColorRgba</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;../constants&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">useTriangle</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> [<span style="color:#a6e22e">collection</span>, <span style="color:#a6e22e">setCollection</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>([]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">uploadTriangle</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">files</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LineReader</span>({});
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">isosurfaceCollection</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">row</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">readHead</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">row</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">row</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 如 有多少个值 值分别为 5,25,30,40,50,60,,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;,&#39;</span>).<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">arr</span>[<span style="color:#ae81ff">0</span>]; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">val</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">arr</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">isosurfaceCollection</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;isosurface-&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">i</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">tins</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">value</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">val</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">getColorRgba</span>(<span style="color:#a6e22e">val</span>), <span style="color:#75715e">//获取value对应的颜色值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        });
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readChunkHead</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">line</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">isosurfaceCollection</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">index</span> <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// row 为2 0行开始，第2行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">targetRow</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">readChunkHead</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">line</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;,&#39;</span>).<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// len = arr[2]; //这一个值域的数组的长度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">targetRow</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">arr</span>[<span style="color:#ae81ff">2</span>]) <span style="color:#f92672">+</span> <span style="color:#a6e22e">row</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 指针加1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">index</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readChunk</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">readChunk</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">next</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// index 等值面数组中的第几个
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">//  targetRow 要读到第几行才算读完这一块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// row 当前的行数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">row</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">row</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">targetRow</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readChunkHead</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">row</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">line</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39;,&#39;</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">filter</span>((<span style="color:#a6e22e">item</span>) =&gt; <span style="color:#a6e22e">item</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">item</span>) =&gt; Number(<span style="color:#a6e22e">item</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// let [x, y, z] = arr;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">let</span> { <span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">z</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Cartesian3</span>.<span style="color:#a6e22e">fromDegrees</span>(...<span style="color:#a6e22e">arr</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">isosurfaceCollection</span>[<span style="color:#a6e22e">index</span>].<span style="color:#a6e22e">tins</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">z</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">next</span>();
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;error&#39;</span>, (<span style="color:#a6e22e">err</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">err</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;progress&#39;</span>, (<span style="color:#a6e22e">proportion</span>) =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(Math.<span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">proportion</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;%&#39;</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;end&#39;</span>, () =&gt; {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;读取结束&#39;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">isosurfaceCollection</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">setCollection</span>(<span style="color:#a6e22e">isosurfaceCollection</span>);
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#39;line&#39;</span>, <span style="color:#a6e22e">readHead</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lr</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">files</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getGeometryInstance</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">positions</span>, <span style="color:#a6e22e">color</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// const positions = new Float64Array(collection[0].tins);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">count</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">positions</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">indices</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#a6e22e">count</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">count</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">indices</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">i</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">geometry</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryPipeline</span>.<span style="color:#a6e22e">computeNormal</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Cesium.GeometryPipeline.toWireframe(
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Geometry</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">position</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryAttribute</span>({
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">componentDatatype</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ComponentDatatype</span>.<span style="color:#a6e22e">DOUBLE</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">componentsPerAttribute</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">values</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">positions</span>,
</span></span><span style="display:flex;"><span>          }),
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">primitiveType</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PrimitiveType</span>.<span style="color:#a6e22e">TRIANGLES</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">boundingSphere</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">BoundingSphere</span>.<span style="color:#a6e22e">fromVertices</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">positions</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// new Cesium.Cartesian3(0.0, 0.0, 0.0),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#75715e">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">indices</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">indices</span>,
</span></span><span style="display:flex;"><span>      })
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeometryInstance</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">geometry</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">geometry</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">attributes</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">color</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">color</span> <span style="color:#75715e">/* new Cesium.ColorGeometryInstanceAttribute(1.0, 1.0, 1.0, 0.5), */</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">onOkTriangle</span> <span style="color:#f92672">=</span> () =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">collection</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instances</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">collection</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">instances</span>.<span style="color:#a6e22e">push</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">getGeometryInstance</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">collection</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">id</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#a6e22e">collection</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">tins</span>),
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">ColorGeometryInstanceAttribute</span>(...<span style="color:#a6e22e">collection</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">color</span>, <span style="color:#ae81ff">0.5</span>)
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">instances</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">appearance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">PerInstanceColorAppearance</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// flat: true,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#75715e">// translucent: true,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">primitive</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">Primitive</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">geometryInstances</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">instances</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">appearance</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">appearance</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">asynchronous</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">primitive</span>);
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">collection</span>, <span style="color:#a6e22e">uploadTriangle</span>, <span style="color:#a6e22e">onOkTriangle</span> };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>加载出的结果：<!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2022/png/29064333/1672310143864-05f493f6-e6bd-41da-a466-ed49a4b7f8d6.png#averageHue=%230d3033&amp;clientId=u42c02e90-65ab-4&amp;from=paste&amp;height=619&amp;id=u95111c05&amp;originHeight=774&amp;originWidth=586&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=278873&amp;status=done&amp;style=none&amp;taskId=u778e4d94-b8d8-4baa-995b-e08bbe923f8&amp;title=&amp;width=468.8" alt="image.png" loading="lazy" /></p>

<!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="5加载等值线">5.加载等值线</h1>
<p>
  <p><img src="https://cdn.nlark.com/yuque/0/2023/png/29064333/1679221438750-45ef14ec-8286-4d4e-bde6-41a1343a9bbc.png#averageHue=%23f3efeb&amp;clientId=u994f0e81-2b24-4&amp;from=paste&amp;height=595&amp;id=u8be7c01d&amp;originHeight=744&amp;originWidth=1920&amp;originalType=binary&amp;ratio=1.25&amp;rotation=0&amp;showTitle=false&amp;size=148955&amp;status=done&amp;style=none&amp;taskId=u2ecae715-00ad-44b0-8886-d91791e1911&amp;title=&amp;width=1536" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->思路：<!-- raw HTML omitted -->逐行读取</p>
<ol>
<li>读取文件类别：ContourPolylines</li>
<li>读取等值组数，一共组少个等值线，每组有几个</li>
<li>读取一组等值线的值和个数</li>
<li>读取该组数据</li>
</ol>
<p>绘制</p>
<ol>
<li>采用instances，primitiveType.Lines</li>
<li>由于每个等值面具有多条线，每条线又或者闭合或不闭合，采用代码生成顶点索引来解决
<ol>
<li>每一行(每条线)的顶点索引为 [0,1,1,2,2,3,3,4&hellip;]</li>
<li>假设当前为第i行，前i-1行共有n个顶点，第i行共有 m 个顶点 ，则当前行的顶点索引为 [n+1,n+2,n+2,n+3&hellip;n+m-1,n+m] 顶点索引必是2的倍数</li>
</ol>
</li>
</ol>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h1 id="实现图层控制">实现图层控制</h1>
<p>要实现图层控制，有两点必须实现的点。</p>
<ol>
<li>控制图层显示和隐藏</li>
<li>定义图层</li>
</ol>
<p>第一点很容易理解，要能够实现我们上面加载的这些种类数据的显示和隐藏，大体如下</p>
<ul>
<li>geojson</li>
<li>entity</li>
<li>primitive
<!-- raw HTML omitted --><!-- raw HTML omitted --></li>
</ul>
<h2 id="geojson">geojson</h2>
<p>回顾一下cesium加载geojson的过程</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeoJsonDataSource</span>.<span style="color:#a6e22e">load</span>(<span style="color:#a6e22e">geojson</span>));
</span></span></code></pre></div><p>可以看到是通过dataSources进行加载的。我们将dataSources打印出来看下<!-- raw HTML omitted -->
  <p><img src="https://cdn.nlark.com/yuque/0/2023/png/29064333/1672914301853-a45e4225-fca7-4b3c-9e7c-1cb8e22712aa.png#averageHue=%23fdfdfd&amp;clientId=u275a6796-01ab-4&amp;from=paste&amp;height=684&amp;id=ud63abdbb&amp;originHeight=855&amp;originWidth=1373&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=149198&amp;status=done&amp;style=none&amp;taskId=uc260fe5d-7c52-44b0-8708-449e0000e41&amp;title=&amp;width=1098.4" alt="image.png" loading="lazy" /></p>
<!-- raw HTML omitted -->可以看到其是一个<code>**dataSource**</code>的集合，可以通过<code>**get(index)**</code>的方式来获取所有的<code>**dataSource**</code>。</p>
<blockquote>
<p>更多dataSourceCollection的用法见官网api <a href="https://cesium.com/learn/cesiumjs/ref-doc/DataSourceCollection.html" target="_blank" rel="noopener">https://cesium.com/learn/cesiumjs/ref-doc/DataSourceCollection.html</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataSources</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">i</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>再通过其show属性就可以控制对应dataSource的显示和隐藏了</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">dataSource</span>.<span style="color:#a6e22e">show</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;<span style="color:#75715e">//true 为显示
</span></span></span></code></pre></div><p>此外要进行图层控制，得知道每个图层的名字，这样才能直观的对对应的图层进行操作。<!-- raw HTML omitted -->dataSource提供一个name属性，DataSourceCollection提供了通过name获得dataSource的方法<code>getByName</code>。因此只需在创建dataSource的时候给它一个name即可。如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataSource</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Cesium</span>.<span style="color:#a6e22e">GeoJsonDataSource</span>(<span style="color:#e6db74">&#39;boua_bianma&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">dataSource</span>.<span style="color:#a6e22e">load</span>(<span style="color:#a6e22e">geojson</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">dataSource</span>);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataSources</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">getByName</span>(<span style="color:#e6db74">&#39;boua_bianma&#39;</span>));<span style="color:#75715e">//注意这里是一个dataSource数组
</span></span></span></code></pre></div><p>到这里geojson部分的就可以实现根据名称来实现其图层显示和隐藏。 <!-- raw HTML omitted -->加载dataSource可能会由于异步的关系有延迟，可以绑定一个加载事件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>.<span style="color:#a6e22e">dataSourceAdded</span>.<span style="color:#a6e22e">addEventListener</span>(
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">dataSources</span>, <span style="color:#a6e22e">dataSource</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">dataSources</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">dataSource</span>);
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">dataSources</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="entity">entity</h2>
<p>有了前面dataSource的经验，entity的显示和隐藏也是类似。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">viewr</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">add</span>()<span style="color:#75715e">//加载
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">_entities</span>.<span style="color:#a6e22e">_array</span> <span style="color:#75715e">//获取一个包含所有entity的数组
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">entity</span>.<span style="color:#a6e22e">show</span><span style="color:#f92672">=</span><span style="color:#66d9ef">false</span> <span style="color:#75715e">//显示隐藏
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">getById</span>(<span style="color:#a6e22e">id</span>)<span style="color:#75715e">//根据id获取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">removeById</span>(<span style="color:#a6e22e">id</span>) <span style="color:#75715e">//根据id移除
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">remove</span>(<span style="color:#a6e22e">entity</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">removeAll</span>() <span style="color:#75715e">//移除所有
</span></span></span></code></pre></div><p>注意需要在加载实体的时候给定<strong>唯一的i</strong>d值</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getUniqueId</span>(<span style="color:#a6e22e">viewer</span>, <span style="color:#a6e22e">id</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">sufixId</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">id</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">entities</span>.<span style="color:#a6e22e">getById</span>(<span style="color:#a6e22e">res</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">undefined</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">sufixId</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sufixId</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<h2 id="primitive">primitive</h2>
<p>考虑到entity是封装了的primitive，因此在进行统计的时候,要去除一个包含所有entity的primitive</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">//方便显示对primitive增加一个name属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">primitive</span>.<span style="color:#a6e22e">name</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;filename&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">add</span>(<span style="color:#a6e22e">primitive</span>);<span style="color:#75715e">//添加primitive
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">get</span>(<span style="color:#a6e22e">index</span>) <span style="color:#75715e">//依据索引获取对应的primitive
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">remove</span>(<span style="color:#a6e22e">primitive</span>) <span style="color:#75715e">//移除指定的primitive
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">removeAll</span>()<span style="color:#75715e">//移除所有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">viewer</span>.<span style="color:#a6e22e">scene</span>.<span style="color:#a6e22e">primitives</span>.<span style="color:#a6e22e">show</span><span style="color:#f92672">=</span><span style="color:#66d9ef">false</span><span style="color:#75715e">//整个集合显示或隐藏
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">primitive</span>.<span style="color:#a6e22e">show</span><span style="color:#f92672">=</span><span style="color:#66d9ef">false</span> <span style="color:#75715e">//整个集合的显示和隐藏
</span></span></span></code></pre></div><p>
  <figure class="figure-image">
    <img src="https://cdn.nlark.com/yuque/0/2023/png/29064333/1673076082177-e7d537d1-175a-44b4-86c8-4c9a68c2745a.png#averageHue=%23fefefe&amp;clientId=ud995dbe3-8320-4&amp;from=paste&amp;height=498&amp;id=uee9396ed&amp;originHeight=622&amp;originWidth=1327&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=true&amp;size=95116&amp;status=done&amp;style=none&amp;taskId=u7ec3b814-5c51-409b-a902-a935b8cfdb5&amp;title=primitiveCollection&amp;width=1061.6" title="primitiveCollection" alt="primitiveCollection" loading="lazy" />
    <figcaption>primitiveCollection</figcaption>
  </figure>
</p>

          </div>
        </div>
                 
      
  
  
  
  

  

  <div class="article-paging">
    
      <section class="post-paging--item card-container content-padding-primary soft-size--primary soft-style--box">
  <div class="card-cover" background-image-lazy data-img="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670747736347-1c7e2143-efbd-451e-835c-2ac2c6142dc6.png"></div>
  <div class="card-text">
    <a href="/docs/yizhiny0989zgxag/"><h4 class="card-text--title text-ellipsis">获取鼠标位置坐标</h4></a>
    <p class="card-text--row">2022-12-11 08:35</p>
  </div>
</section>
    
    
      <section class="post-paging--item card-container content-padding-primary soft-size--primary soft-style--box">
  <div class="card-cover" background-image-lazy data-img="https://cdn.nlark.com/yuque/0/2022/png/29064333/1670729289748-1914327a-547b-410e-b28f-23e12b9bb914.png"></div>
  <div class="card-text">
    <a href="/docs/gb6gb3cwgbt5y190/"><h4 class="card-text--title text-ellipsis">去除cesium默认控件</h4></a>
    <p class="card-text--row">2022-12-11 02:54</p>
  </div>
</section>
    
  </div>
</div>
  <aside class="widget-info">
    
<section class="aside-widget widget-author content-padding-large soft-size--large soft-style--box">
  <div class="widget-body">
    <div class="author-box avatar">
      
      <img class="author-avatar soft-size--round soft-style--box" src="https://cdn.jsdelivr.net/gh/Sentisfate/wanhuatong@main/img/cdai.jfif" alt="gisculibur">
      
      <h2 class="author-name text-ellipsis">gisculibur</h2>
      
      <p class="author-desc text-ellipsis">新手WebGIS攻城狮</p>
      
    </div>
  </div>
</section>


    

<section class="aside-widget widget-toc content-padding-large soft-size--large soft-style--box">
  <h2 class="widget-header">
    <div class="title">
      <span>目录</span>
    </div>
  </h2>
  <div class="widget-body">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1shapefile">1.shapefile</a></li>
    <li><a href="#2在指定位置加载一张图片-img">2.在指定位置加载一张图片 img</a></li>
    <li><a href="#3加载栅格数据如-ascii">3.加载栅格数据如 ascii</a>
      <ul>
        <li><a href="#线性拉伸">线性拉伸</a></li>
        <li><a href="#读写像素">读写像素</a></li>
      </ul>
    </li>
    <li><a href="#4加载等值面三角网">4.加载等值面三角网</a>
      <ul>
        <li><a href="#画一个三角形">画一个三角形</a></li>
        <li><a href="#加载不同顶点颜色的三角形">加载不同顶点颜色的三角形</a></li>
        <li><a href="#动态修改三角形的颜色">动态修改三角形的颜色</a></li>
        <li><a href="#踩坑之路">踩坑之路</a>
          <ul>
            <li><a href="#问题1">问题1.</a></li>
            <li><a href="#问题2顶点索引相关问题">问题2.顶点索引相关问题</a></li>
          </ul>
        </li>
        <li><a href="#读取csv">读取csv</a></li>
      </ul>
    </li>
    <li><a href="#5加载等值线">5.加载等值线</a></li>
    <li><a href="#实现图层控制">实现图层控制</a>
      <ul>
        <li><a href="#geojson">geojson</a></li>
        <li><a href="#entity">entity</a></li>
        <li><a href="#primitive">primitive</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</section>


    










<section class="aside-widget widget-articles content-padding-large soft-size--large soft-style--box">
  <h2 class="widget-header">
    <div class="title">
      <span>相关文章</span>
    </div>
  </h2>
  <div class="widget-body">
    <ul class="post-list">
      
      
        <li class="post-item"><a href="/docs/ix726493ddpi6i3q/">3dTiles</a></li>
      
        <li class="post-item"><a href="/posts/qa4vydlw37pbsi3v/">WebGL 图像处理</a></li>
      
        <li class="post-item"><a href="/docs/goz05uyu3i5v92c9/">Cesium 模型压平</a></li>
      
        <li class="post-item"><a href="/docs/cl6l0mww8kkkizwb/">三角剖分</a></li>
      
        <li class="post-item"><a href="/docs/prgrgit7lss8vggf/">GIS理论基础</a></li>
      
        <li class="post-item"><a href="/docs/vzxnspucb4agb00w/">问题</a></li>
      
    </ul>
  </div>
</section>


    




<section class="aside-widget widget-categories content-padding-large soft-size--large soft-style--box">
  <h2 class="widget-header">
    <div class="title">
      <span>分类</span>
    </div>
  </h2>
  <div class="widget-body">
    <ul class="categories-list">
      
        <li>
          <a href="https://Sentisfate.github.io/categories/webgl/">WebGL</a>
          <span>1</span>
        </li>
      
        <li>
          <a href="https://Sentisfate.github.io/categories/%E5%9B%BE%E5%BA%8A/">图床</a>
          <span>1</span>
        </li>
      
    </ul>
  </div>

  
</section>


    




<section class="aside-widget widget-tags content-padding-large soft-size--large soft-style--box">
  <h2 class="widget-header">
    <div class="title">
      <span>标签</span>
    </div>
  </h2>
  <div class="widget-body">
    <div class="tags-list">
      
        <a href="https://Sentisfate.github.io/tags/github/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">github</a>
      
        <a href="https://Sentisfate.github.io/tags/picgo/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">picgo</a>
      
        <a href="https://Sentisfate.github.io/tags/%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">图像处理</a>
      
    </div>
  </div>

  
</section>

  </aside>
</div>
  </main><footer class="footer-container layout-block">
  
  <div class="social-icons">
    
      <a class="soft-size--primary soft-style--box" href="https://github.com/Sentisfate" target="_blank" rel="noopener noreferrer">
          
        <svg class="icon icon-github" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <path d="M64.6 512c0 195.6 125.4 361.9 300.1 422.9 23.5 5.9 19.9-10.8 19.9-22.2v-77.6c-135.8 15.9-141.3-74-150.5-89-18.5-31.5-61.9-39.5-49-54.5 31-15.9 62.5 4 98.9 58 26.4 39.1 77.9 32.5 104.1 26 5.7-23.5 17.9-44.5 34.7-60.9-140.7-25.2-199.4-111.1-199.4-213.3 0-49.5 16.4-95.1 48.4-131.8-20.4-60.6 1.9-112.4 4.9-120.1 58.2-5.2 118.5 41.6 123.3 45.3 33.1-8.9 70.8-13.7 112.9-13.7 42.4 0 80.3 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.4-43.9 2.9 7.7 24.7 58.3 5.5 118.1 32.5 36.8 49 82.8 49 132.4 0 102.3-59 188.3-200.2 213.2 23.5 23.3 38.1 55.5 38.1 91.1v112.7c0.8 9 0 17.9 15.1 17.9C832.7 877 960.4 709.4 960.4 512.1c0-247.5-200.6-447.9-447.9-447.9C265 64.1 64.6 264.5 64.6 512z"></path>
        </svg>
        

        

        

        

        
      </a>
    
  </div>
  

  <div class="colour-bar"></div>
  
  

  

  <p>
    Powered by
    <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a>
    Theme - 
    <a href="https://github.com/miiiku/hugo-theme-kagome" target="_blank" rel="noopener noreferrer author">kagome</a>
  </p>

  <p>
    <a href="javascript:;" id="theme-light">🌞 浅色</a>
    <a href="javascript:;" id="theme-dark">🌛 深色</a>
    <a href="javascript:;" id="theme-auto">🤖️ 自动</a>
  </p>
</footer>



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>






</body>

</html>